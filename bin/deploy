#!/usr/bin/env bash

if ! which flyctl >/dev/null 2>&1; then
  echo "Please install flyctl: https://fly.io/docs/flyctl/install"
  exit 1
fi

flyctl deploy

flyctl ssh console --command 'sh -c "
  swapoff /.fly-upper-layer/swapfile; \
  fallocate -l 2048M /.fly-upper-layer/swapfile && \
  chmod 0600 /.fly-upper-layer/swapfile && \
  mkswap /.fly-upper-layer/swapfile && \
  sysctl -w vm.swappiness=10 && \
  swapon /.fly-upper-layer/swapfile
"'
