#!/usr/bin/env bash

if ! which flyctl >/dev/null 2>&1; then
  echo "Please install flyctl: https://fly.io/docs/flyctl/install"
  exit 1
fi

flyctl deploy

flyctl ssh console --command 'sh -c "
  sysctl -w vm.swappiness=25 && \
  fallocate -l 128M /.fly-upper-layer/swapfile1 && \
  chmod 0600 /.fly-upper-layer/swapfile1 && \
  mkswap /.fly-upper-layer/swapfile1 && \
  swapon /.fly-upper-layer/swapfile1 && \
  fallocate -l 128M /.fly-upper-layer/swapfile2 && \
  chmod 0600 /.fly-upper-layer/swapfile2 && \
  mkswap /.fly-upper-layer/swapfile2 && \
  swapon /.fly-upper-layer/swapfile2 && \
  fallocate -l 128M /.fly-upper-layer/swapfile3 && \
  chmod 0600 /.fly-upper-layer/swapfile3 && \
  mkswap /.fly-upper-layer/swapfile3 && \
  swapon /.fly-upper-layer/swapfile3
"'
